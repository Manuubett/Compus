<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Network — FollowUp Connect</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>

  <style>
    :root { --blue:#0066ff; --muted:#6b7280; --card:#fff; --bg:#f0f4f9; }
    body { font-family: 'Poppins',sans-serif; background:var(--bg); margin:0; color:#111; }
    header { background:var(--blue); color:#fff; padding:18px 12px; text-align:center; }
    .container { max-width:1100px; margin:20px auto; padding:0 16px; display:grid; grid-template-columns:1fr 340px; gap:30px; }
    .main-content {}
    .controls { display:flex; gap:12px; flex-wrap:wrap; margin:16px 0; align-items:center; }
    .controls input, .controls select { padding:10px 12px; border-radius:8px; border:1px solid #ddd; font-size:0.95rem; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:14px; }
    .card { background:var(--card); padding:14px; border-radius:12px; box-shadow:0 4px 12px rgba(20,20,40,0.04); }
    .user-row { display:flex; gap:12px; align-items:center; }
    .avatar { width:56px; height:56px; border-radius:50%; object-fit:cover; }
    .btn { padding:8px 12px; border-radius:8px; border:0; cursor:pointer; font-weight:600; font-size:0.92rem; }
    .btn-primary { background:var(--blue); color:#fff; }
    .btn-muted { background:#eef2ff; color:var(--blue); }
    .btn-pending { background:#f3f4f6; color:#444; }
    .btn-danger { background:#ffeef0; color:#c4302b; }
    .small { font-size:0.88rem; color:var(--muted); }

    /* Requests Sidebar */
    .requests-sidebar {
      background:var(--card);
      border-radius:12px;
      padding:16px;
      box-shadow:0 4px 12px rgba(20,20,40,0.04);
      height:fit-content;
    }
    .requests-sidebar h3 { color:var(--blue); margin-bottom:12px; font-weight:600; }
    .request-item {
      display:flex; align-items:center; gap:12px; padding:10px 0;
      border-bottom:1px solid #eee;
    }
    .request-item:last-child { border:none; }
    .request-item img { width:48px; height:48px; border-radius:50%; }

    /* Drawer & Modal */
    .profile-drawer {
      position:fixed; right:12px; top:80px; width:320px; max-width:90%;
      background:#fff; border-radius:12px; box-shadow:0 20px 40px rgba(10,10,30,0.12);
      padding:16px; display:none; z-index:120;
    }
    .drawer-close { margin-left:auto; cursor:pointer; font-size:1.4rem; color:var(--muted); }
    .section-title { color:var(--blue); margin:8px 0 12px; font-weight:600; }
    .empty { text-align:center; color:var(--muted); padding:30px 0; }

    .modal {
      display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6);
      z-index:9999; justify-content:center; align-items:center;
    }
    .modal-content {
      background:white; padding:32px; border-radius:16px; text-align:center;
      max-width:400px; box-shadow:0 20px 40px rgba(0,0,0,0.3);
    }
    nav {
  background: blue;
  padding: 10px 200px;
  display: flex;
  gap: 50px;
}

nav a {
  color: #fff;
  text-decoration: none;
  font-size: 16px;
  padding: 8px 12px;
  border-radius: 6px;
  transition: 0.3s ease;
}

nav a:hover {
  background: #444;
}
    .modal-icon { font-size:4rem; color:#27ae60; margin-bottom:16px; }

    @media(max-width:820px){ .container { grid-template-columns:1fr; } .requests-sidebar { order:-1; margin-bottom:20px; } }
    @media(max-width:520px){ .controls { flex-direction:column; } }

  </style>
</head>
<body>

<header>
  <h1>Network — Find People & Mentors</h1>
  <div class="small">Search, connect, and grow your professional network</div>
  
</header>
<nav>
    <a href="chat.html">chats</a>

  </nav>

<div class="container">
  <div class="main-content">
    <div class="controls">
      <input id="searchInput" placeholder="Search by name, campus, course, or year..." />
      <select id="statusFilter">
        <option value="">All status</option>
        <option value="Undergraduate">Undergraduate</option>
        <option value="Graduate">Graduate</option>
        <option value="Non-Undergraduate">Non-Undergraduate</option>
      </select>
      <select id="sortBy">
        <option value="recent">Newest</option>
        <option value="connections">Most connected</option>
      </select>
      <div style="margin-left:auto;">
        <button id="myRequestsBtn" class="btn btn-muted">Requests</button>
      </div>
    </div>

    <div id="results" class="grid"></div>
    <div id="empty" class="empty" style="display:none;">No users found.</div>
  </div>

  <!-- Incoming Requests Sidebar -->
  <div class="requests-sidebar">
    <h3>Incoming Requests</h3>
    <div id="requestsList">
      <div class="small" style="text-align:center;padding:30px;color:#888;">No pending requests</div>
    </div>
  </div>
</div>

<!-- Profile Drawer -->
<div id="drawer" class="profile-drawer">
  <div style="display:flex;align-items:center;gap:12px;">
    <img id="drawerAvatar" src="https://via.placeholder.com/80" width="72" height="72" style="border-radius:8px;object-fit:cover">
    <div>
      <div id="drawerName" style="font-weight:700"></div>
      <div id="drawerCampus" class="small"></div>
    </div>
    <div class="drawer-close" id="drawerClose">×</div>
  </div>
  <div style="margin-top:12px;">
    <div class="section-title">About</div>
    <div id="drawerCourse" class="small"></div>
    <div id="drawerStatus" class="small"></div>
    <div id="drawerGradYear" class="small"></div>
    <div id="drawerWork" class="small"></div>
    <div style="margin-top:16px;display:flex;gap:8px;">
      <button id="drawerConnectBtn" class="btn btn-primary">Connect</button>
      <button id="drawerMessageBtn" class="btn btn-muted">Message</button>
    </div>
  </div>
</div>

<!-- Acceptance Modal -->
<div class="modal" id="successModal">
  <div class="modal-content">
    <div class="modal-icon"><i class="fas fa-check-circle"></i></div>
    <h3>Connection Accepted!</h3>
    <p id="acceptedName" style="margin:16px 0;font-size:1.1rem;"></p>
    <button class="btn btn-primary" onclick="openChatFromModal()">Send Message</button>
    <div style="margin-top:12px;"><a href="#" style="color:var(--blue)" onclick="document.getElementById('successModal').style.display='none'">Dismiss</a></div>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyC23iQpw8dvOamO5FpcrWWlgTwJ8gvmuM4",
    authDomain: "reconnect-10733.firebaseapp.com",
    projectId: "reconnect-10733",
    storageBucket: "reconnect-10733.firebasestorage.app",
    messagingSenderId: "902709752297",
    appId: "1:902709752297:web:b89e694688d25472ac1b78"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const results = document.getElementById('results');
  const searchInput = document.getElementById('searchInput');
  const statusFilter = document.getElementById('statusFilter');
  const sortBy = document.getElementById('sortBy');
  const empty = document.getElementById('empty');
  const drawer = document.getElementById('drawer');
  const drawerClose = document.getElementById('drawerClose');
  const drawerAvatar = document.getElementById('drawerAvatar');
  const drawerName = document.getElementById('drawerName');
  const drawerCampus = document.getElementById('drawerCampus');
  const drawerCourse = document.getElementById('drawerCourse');
  const drawerStatus = document.getElementById('drawerStatus');
  const drawerGradYear = document.getElementById('drawerGradYear');
  const drawerWork = document.getElementById('drawerWork');
  const drawerConnectBtn = document.getElementById('drawerConnectBtn');
  const drawerMessageBtn = document.getElementById('drawerMessageBtn');

  let currentUser = null;
  let profiles = [];
  let lastAcceptedUid = null;

  auth.onAuthStateChanged(async user => {
    if (!user) return location.href = "index.html";
    currentUser = user;
    await loadProfiles();
    renderRequests();
    listenForAcceptances();
  });

  async function loadProfiles() {
    results.innerHTML = '<div class="small">Loading users...</div>';
    const snap = await db.collection('users').get();
    profiles = snap.docs.map(d => ({ uid: d.id, ...d.data() })).filter(p => p.name);
    renderProfiles();
  }

  async function getConnectionState(targetUid) {
    if (!currentUser || currentUser.uid === targetUid) return 'self';
    const userDoc = await db.collection("users").doc(currentUser.uid).get();
    const data = userDoc.data() || {};
    if (data.connections?.includes(targetUid)) return 'connected';
    if (data.sentRequests?.includes(targetUid)) return 'pending_sent';
    if (data.receivedRequests?.includes(targetUid)) return 'pending_received';
    return 'none';
  }

  async function renderProfiles() {
    const q = searchInput.value.trim().toLowerCase();
    const status = statusFilter.value;

    let list = profiles.filter(p => p.uid !== currentUser.uid);

    if (status) list = list.filter(p => (p.status || '').toLowerCase() === status.toLowerCase());
    if (q) {
      list = list.filter(p => 
        (p.name?.toLowerCase().includes(q)) ||
        (p.campus?.toLowerCase().includes(q)) ||
        (p.course?.toLowerCase().includes(q)) ||
        String(p.gradYear || '').includes(q)
      );
    }

    results.innerHTML = '';
    if (!list.length) { empty.style.display = 'block'; return; }
    empty.style.display = 'none';

    for (const profile of list) {
      const state = await getConnectionState(profile.uid);

      let actionHtml = '';
      if (state === 'connected') {
        actionHtml = `<div style="display:flex;gap:8px;">
          <button class="btn btn-muted" onclick="viewProfile('${profile.uid}')">View</button>
          <button class="btn btn-primary" onclick="openChat('${profile.uid}')">Message</button>
        </div>`;
      } else if (state === 'pending_sent') {
        actionHtml = `<button class="btn btn-pending" onclick="cancelRequest('${profile.uid}')">Pending</button>`;
      } else if (state === 'pending_received') {
        actionHtml = `<div style="display:flex;gap:8px;">
          <button class="btn btn-primary" onclick="acceptRequest('${profile.uid}')">Accept</button>
          <button class="btn" onclick="declineRequest('${profile.uid}')">Decline</button>
        </div>`;
      } else {
        actionHtml = `<div style="display:flex;gap:8px;">
          <button class="btn btn-primary" onclick="sendRequest('${profile.uid}')">Connect</button>
          <button class="btn btn-muted" onclick="viewProfile('${profile.uid}')">View</button>
        </div>`;
      }

      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="user-row">
          <img class="avatar" src="${profile.photoUrl || 'https://via.placeholder.com/56'}" alt="">
          <div style="flex:1;">
            <div style="font-weight:700">${profile.name}</div>
            <div class="small">${profile.course || ''} • ${profile.campus || ''}</div>
            <div style="margin-top:10px;">${actionHtml}</div>
          </div>
        </div>
      `;
      results.appendChild(card);
    }
  }

  // Sidebar: Incoming Requests
  async function renderRequests() {
    const list = document.getElementById("requestsList");
    const myDoc = await db.collection("users").doc(currentUser.uid).get();
    const requests = myDoc.data()?.receivedRequests || [];

    if (requests.length === 0) {
      list.innerHTML = `<div class="small" style="text-align:center;padding:30px;color:#888;">No pending requests</div>`;
      return;
    }

    list.innerHTML = "";
    for (const uid of requests.slice(0,6)) {
      const userDoc = await db.collection("users").doc(uid).get();
      if (!userDoc.exists) continue;
      const u = userDoc.data();

      const item = document.createElement("div");
      item.className = "request-item";
      item.innerHTML = `
        <img src="${u.photoUrl || 'https://via.placeholder.com/48'}" alt="">
        <div style="flex:1;">
          <div style="font-weight:600;">${u.name || 'User'}</div>
          <div class="small" style="color:#666;">Wants to connect</div>
        </div>
        <button class="btn btn-primary" style="padding:6px 12px;font-size:0.9rem;" onclick="acceptRequest('${uid}')">
          Accept
        </button>
      `;
      list.appendChild(item);
    }
  }

  // Connection actions
  async function sendRequest(uid) {
    await db.collection("users").doc(currentUser.uid).update({ sentRequests: firebase.firestore.FieldValue.arrayUnion(uid) });
    await db.collection("users").doc(uid).update({ receivedRequests: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
    renderProfiles();
  }

  async function cancelRequest(uid) {
    await db.collection("users").doc(currentUser.uid).update({ sentRequests: firebase.firestore.FieldValue.arrayRemove(uid) });
    await db.collection("users").doc(uid).update({ receivedRequests: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });
    renderProfiles();
  }

  async function acceptRequest(uid) {
    const userSnap = await db.collection("users").doc(uid).get();
    const userData = userSnap.data();

    await db.collection("users").doc(currentUser.uid).update({
      connections: firebase.firestore.FieldValue.arrayUnion(uid),
      receivedRequests: firebase.firestore.FieldValue.arrayRemove(uid)
    });
    await db.collection("users").doc(uid).update({
      connections: firebase.firestore.FieldValue.arrayUnion(currentUser.uid),
      sentRequests: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
    });

    lastAcceptedUid = uid;
    document.getElementById("acceptedName").textContent = `${userData.name} accepted your connection request!`;
    document.getElementById("successModal").style.display = "flex";

    renderProfiles();
    renderRequests();
  }

  async function declineRequest(uid) {
    await db.collection("users").doc(currentUser.uid).update({ receivedRequests: firebase.firestore.FieldValue.arrayRemove(uid) });
    await db.collection("users").doc(uid).update({ sentRequests: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });
    renderProfiles();
  }

  function openChat(uid) {
    window.location.href = `chat.html?with=${uid}`;
  }

  function openChatFromModal() {
    document.getElementById("successModal").style.display = "none";
    if (lastAcceptedUid) openChat(lastAcceptedUid);
  }

  // Real-time: someone accepted your request
  function listenForAcceptances() {
    db.collection("users").doc(currentUser.uid).onSnapshot(doc => {
      const data = doc.data() || {};
      const sent = data.sentRequests || [];

      if (window.lastSent) {
        window.lastSent.forEach(uid => {
          if (!sent.includes(uid) && (data.connections || []).includes(uid)) {
            const user = profiles.find(p => p.uid === uid);
            if (user) {
              lastAcceptedUid = uid;
              document.getElementById("acceptedName").textContent = `${user.name} accepted your request!`;
              document.getElementById("successModal").style.display = "flex";
            }
          }
        });
      }
      window.lastSent = sent;
    });
  }

  // Profile drawer
  async function viewProfile(uid) {
    const snap = await db.collection('users').doc(uid).get();
    if (!snap.exists) return;
    const p = snap.data();
    drawerAvatar.src = p.photoUrl || 'https://via.placeholder.com/80';
    drawerName.textContent = p.name || 'Unknown';
    drawerCampus.textContent = p.campus || '';
    drawerCourse.textContent = p.course ? 'Course: ' + p.course : '';
    drawerStatus.textContent = p.status ? 'Status: ' + p.status : '';
    drawerGradYear.textContent = p.gradYear ? 'Graduation: ' + p.gradYear : '';
    drawerWork.textContent = p.workStatus ? 'Work: ' + p.workStatus : '';
    drawer.style.display = 'block';

    const state = await getConnectionState(uid);
    drawerConnectBtn.textContent = state === 'connected' ? 'Connected' : state === 'pending_sent' ? 'Pending' : 'Connect';
    drawerMessageBtn.onclick = () => openChat(uid);
  }

  drawerClose.onclick = () => drawer.style.display = 'none';

  // Search & filters
  ['input','change'].forEach(ev => {
    searchInput.addEventListener(ev, () => {
      clearTimeout(window.t);
      window.t = setTimeout(renderProfiles, 300);
    });
    statusFilter.addEventListener(ev, renderProfiles);
    sortBy.addEventListener(ev, renderProfiles);
  });

</script>

</body>
</html>